name: Status Updates, Reminders & Weekly Summary

on:
  schedule:
    # Runs every day at 9:00 AM UTC
    - cron: "0 9 * * *"
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: write

jobs:
  status-updates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # -------------------- STALE ISSUES --------------------
      - name: Check Stale Issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const DAYS = 30;
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - DAYS);

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'updated',
              direction: 'asc',
              per_page: 100
            });

            for (const issue of issues.data) {
              if (issue.pull_request) continue;

              const lastUpdated = new Date(issue.updated_at);
              const isStale = lastUpdated < cutoff;
              const alreadyStale = issue.labels.some(l => l.name === 'stale');

              if (isStale && !alreadyStale) {
                const days = Math.floor((Date.now() - lastUpdated) / (1000 * 60 * 60 * 24));

                const message = [
                  `## ‚è∞ Issue Inactivity Reminder`,
                  ``,
                  `This issue has been inactive for **${days} days**.`,
                  ``,
                  `### üîÑ What should you do?`,
                  `- Still working on it? ‚ûú Please share an update`,
                  `- Need help? ‚ûú Ask maintainers or fellow contributors`,
                  `- Issue resolved? ‚ûú Close this issue`,
                  ``,
                  `### üìÖ Last Activity`,
                  `- **Last Updated:** ${lastUpdated.toDateString()}`,
                  ``,
                  `---`,
                  `*Automated reminder for ECWoC'26 ‚Äì 100 Days of Web Development*`
                ].join('\n');

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: message
                });

                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['stale']
                });
              }
            }

      # -------------------- STALE PRs --------------------
      - name: Check Stale Pull Requests
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const DAYS = 7;
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - DAYS);

            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'updated',
              direction: 'asc',
              per_page: 100
            });

            for (const pr of prs.data) {
              const lastUpdated = new Date(pr.updated_at);
              const isStale = lastUpdated < cutoff;
              const alreadyStale = pr.labels.some(l => l.name === 'stale');

              if (isStale && !alreadyStale) {
                const days = Math.floor((Date.now() - lastUpdated) / (1000 * 60 * 60 * 24));

                const message = [
                  `## ‚è∞ Pull Request Inactivity Reminder`,
                  ``,
                  `This PR has been inactive for **${days} days**.`,
                  ``,
                  `### üîÑ Next Steps`,
                  `- Ready for review? ‚ûú Request review`,
                  `- Changes required? ‚ûú Push updates`,
                  `- No longer needed? ‚ûú Close this PR`,
                  ``,
                  `### üìÖ Last Activity`,
                  `- **Last Updated:** ${lastUpdated.toDateString()}`,
                  ``,
                  `---`,
                  `*Automated reminder for ECWoC'26 ‚Äì 100 Days of Web Development*`
                ].join('\n');

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: message
                });

                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  labels: ['stale']
                });
              }
            }

      # -------------------- WEEKLY SUMMARY --------------------
      - name: Weekly Project Summary
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const today = new Date();
            const weekStart = new Date();
            weekStart.setDate(today.getDate() - 7);

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              since: weekStart.toISOString(),
              per_page: 100
            });

            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });

            const newIssues = issues.data.filter(i => !i.pull_request && new Date(i.created_at) >= weekStart);
            const newPRs = prs.data.filter(p => new Date(p.created_at) >= weekStart);
            const mergedPRs = prs.data.filter(p => p.merged_at && new Date(p.merged_at) >= weekStart);

            const contributors = new Set([
              ...newIssues.map(i => i.user.login),
              ...newPRs.map(p => p.user.login)
            ]);

            const body = [
              `## üìä Weekly Project Summary`,
              ``,
              `**Repository:** 100-Days-Of-Web-Development-ECWoC26`,
              `**Duration:** ${weekStart.toDateString()} ‚Üí ${today.toDateString()}`,
              ``,
              `### üìà Activity Overview`,
              `- üÜï New Issues: **${newIssues.length}**`,
              `- üöÄ New Pull Requests: **${newPRs.length}**`,
              `- ‚úÖ Merged PRs: **${mergedPRs.length}**`,
              `- üë• Active Contributors: **${contributors.size}**`,
              ``,
              `### üéØ Focus for Next Week`,
              `- Review pending PRs`,
              `- Resolve stale issues`,
              `- Help new contributors`,
              `- Improve documentation & examples`,
              ``,
              `---`,
              `*Automated weekly summary for ECWoC'26*`
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üìä Weekly Summary ‚Äì ${today.toDateString()}`,
              body,
              labels: ['weekly-summary', 'automated']
            });
